name: Azure - Deploy (enterprise)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "backend/**"
      - "frontend/**"
      - "Dockerfile"
      - ".github/workflows/azure-deploy.yml"
      - "infra/azure/**"

permissions:
  id-token: write
  contents: read

concurrency:
  group: azure-deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
      AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
      AZURE_WEBAPP_NAME: ${{ vars.AZURE_WEBAPP_NAME }}
      AZURE_ACR_NAME: ${{ vars.AZURE_ACR_NAME }}
      IMAGE_REPO: ${{ vars.IMAGE_REPO || 'chocoai' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Optional but recommended: build backend so CI fails early if TS/Prisma broken
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: |
            backend/package-lock.json
            package-lock.json

      - name: Build backend (dist) - sanity check
        run: |
          set -euo pipefail
          npm ci --prefix backend
          DATABASE_URL="postgresql://user:pass@localhost:5432/chocoai?schema=public" npm run db:generate --prefix backend
          npm run build --prefix backend

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Validate required variables
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            : "${AZURE_RESOURCE_GROUP:?Missing vars.AZURE_RESOURCE_GROUP}"
            : "${AZURE_WEBAPP_NAME:?Missing vars.AZURE_WEBAPP_NAME}"
            : "${AZURE_ACR_NAME:?Missing vars.AZURE_ACR_NAME}"
            echo "OK: RG=$AZURE_RESOURCE_GROUP WEBAPP=$AZURE_WEBAPP_NAME ACR=$AZURE_ACR_NAME IMAGE_REPO=$IMAGE_REPO"

      - name: Resolve ACR + WebApp resource IDs
        id: ids
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            RG="$AZURE_RESOURCE_GROUP"
            ACR="$AZURE_ACR_NAME"
            WEBAPP="$AZURE_WEBAPP_NAME"

            ACR_ID="$(az acr show -g "$RG" -n "$ACR" --query id -o tsv)"
            ACR_LOGIN_SERVER="$(az acr show -g "$RG" -n "$ACR" --query loginServer -o tsv)"
            WEBAPP_ID="$(az webapp show -g "$RG" -n "$WEBAPP" --query id -o tsv)"

            echo "ACR_ID=$ACR_ID" >> "$GITHUB_ENV"
            echo "ACR_LOGIN_SERVER=$ACR_LOGIN_SERVER" >> "$GITHUB_ENV"
            echo "WEBAPP_ID=$WEBAPP_ID" >> "$GITHUB_ENV"

            echo "ACR login server: $ACR_LOGIN_SERVER"

      - name: Ensure WebApp managed identity exists + AcrPull on ACR
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            RG="$AZURE_RESOURCE_GROUP"
            WEBAPP="$AZURE_WEBAPP_NAME"
            ACR_ID="$ACR_ID"

            # Ensure system-assigned managed identity
            PRINCIPAL_ID="$(az webapp identity assign -g "$RG" -n "$WEBAPP" --query principalId -o tsv)"
            echo "WebApp principalId: $PRINCIPAL_ID"

            # Grant AcrPull (idempotent-ish)
            HAS_ROLE="$(az role assignment list --assignee "$PRINCIPAL_ID" --scope "$ACR_ID" --query "[?roleDefinitionName=='AcrPull'] | length(@)" -o tsv)"
            if [ "${HAS_ROLE:-0}" = "0" ]; then
              az role assignment create --assignee "$PRINCIPAL_ID" --role AcrPull --scope "$ACR_ID" >/dev/null
              echo "Granted AcrPull on ACR to WebApp identity."
            else
              echo "AcrPull already granted."
            fi

      - name: Build image in ACR (server-side)
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            RG="$AZURE_RESOURCE_GROUP"
            ACR="$AZURE_ACR_NAME"

            TAG="${GITHUB_SHA::7}"
            IMAGE_NAME="$IMAGE_REPO"
            echo "IMAGE_TAG=$TAG" >> "$GITHUB_ENV"

            echo "ACR build: $ACR/$IMAGE_NAME:$TAG and :latest"
            az acr build -g "$RG" -r "$ACR" \
              -t "$IMAGE_NAME:$TAG" \
              -t "$IMAGE_NAME:latest" \
              .

      - name: Update Web App to new image
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            RG="$AZURE_RESOURCE_GROUP"
            WEBAPP="$AZURE_WEBAPP_NAME"
            ACR_SERVER="$ACR_LOGIN_SERVER"
            TAG="$IMAGE_TAG"

            IMAGE="$ACR_SERVER/$IMAGE_REPO:$TAG"
            echo "Deploying image: $IMAGE"

            # Configure container (use ACR + managed identity pull)
            az webapp config container set \
              --resource-group "$RG" \
              --name "$WEBAPP" \
              --docker-custom-image-name "$IMAGE" \
              --docker-registry-server-url "https://$ACR_SERVER"

            # IMPORTANT: Make sure App Service routes to the same port your Node listens on.
            az webapp config appsettings set \
              --resource-group "$RG" \
              --name "$WEBAPP" \
              --settings \
                NODE_ENV=production \
                PORT=8080 \
                WEBSITES_PORT=8080

            # Secrets from GitHub Secrets
            az webapp config appsettings set \
              --resource-group "$RG" \
              --name "$WEBAPP" \
              --settings \
                DATABASE_URL='${{ secrets.DATABASE_URL }}' \
                OPENAI_API_KEY='${{ secrets.OPENAI_API_KEY }}' \
                JWT_SECRET='${{ secrets.JWT_SECRET }}' \
                ROOT_URL='${{ secrets.ROOT_URL }}' \
                GOOGLE_MAPS_API_KEY='${{ secrets.GOOGLE_MAPS_API_KEY }}'

            az webapp restart --resource-group "$RG" --name "$WEBAPP"

      - name: Show last container logs (best-effort)
        if: always()
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            RG="$AZURE_RESOURCE_GROUP"
            WEBAPP="$AZURE_WEBAPP_NAME"
            echo "Tip: If site shows 503, check Log Stream in Azure Portal or run:"
            echo "az webapp log config -g $RG -n $WEBAPP --docker-container-logging filesystem"
            echo "az webapp log tail   -g $RG -n $WEBAPP"
