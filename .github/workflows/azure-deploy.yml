name: Azure - Deploy

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'Dockerfile'
      - '.github/workflows/azure-deploy.yml'
      - 'infra/azure/**'

permissions:
  id-token: write
  contents: read

concurrency:
  group: azure-deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
      AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
      AZURE_WEBAPP_NAME: ${{ vars.AZURE_WEBAPP_NAME }}
      AZURE_ACR_NAME: ${{ vars.AZURE_ACR_NAME }}
      IMAGE_REPO: chocoai

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: |
            backend/package-lock.json
            package-lock.json

      - name: Build backend (dist)
        run: |
          set -euo pipefail
          npm ci --prefix backend
          DATABASE_URL="postgresql://user:pass@localhost:5432/chocoai?schema=public" npm run db:generate --prefix backend
          npm run build --prefix backend

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID || vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID || vars.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID || vars.AZURE_SUBSCRIPTION_ID }}

      - name: Resolve (or create) ACR + resolve WebApp
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail

            RG="${AZURE_RESOURCE_GROUP:-}"
            LOC="${AZURE_LOCATION:-israelcentral}"
            ACR_NAME="${AZURE_ACR_NAME:-}"
            WEBAPP="${AZURE_WEBAPP_NAME:-}"

            if [ -z "$RG" ]; then
              echo "Missing GitHub variable: AZURE_RESOURCE_GROUP"
              exit 1
            fi

            echo "Using RG=$RG LOC=$LOC"

            # ---- Resolve WebApp (must exist) ----
            if [ -z "$WEBAPP" ]; then
              WEBAPP="$(az webapp list -g "$RG" --query '[?contains(name, `chocoai`)].name | [0]' -o tsv || true)"
              if [ -z "$WEBAPP" ]; then
                WEBAPP="$(az webapp list -g "$RG" --query '[0].name' -o tsv || true)"
              fi
            fi

            if [ -z "$WEBAPP" ]; then
              echo "Could not find any Web App in resource group '$RG'."
              echo "Run the Provision workflow first (Azure - Provision) or set AZURE_WEBAPP_NAME."
              exit 1
            fi

            echo "Resolved WEBAPP=$WEBAPP"

            # ---- Resolve or Create ACR ----
            if [ -z "$ACR_NAME" ]; then
              ACR_NAME="$(az acr list -g "$RG" --query '[?contains(name, `chocoai`)].name | [0]' -o tsv || true)"
              if [ -z "$ACR_NAME" ]; then
                ACR_NAME="$(az acr list -g "$RG" --query '[0].name' -o tsv || true)"
              fi
            fi

            if [ -z "$ACR_NAME" ]; then
              # Create a new ACR if none exists
              RAW="chocoai${GITHUB_RUN_ID}"
              ACR_NAME="$(echo "$RAW" | tr '[:upper:]' '[:lower:]' | tr -cd 'a-z0-9' | cut -c1-32)"
              echo "No ACR found in RG. Creating ACR: $ACR_NAME"
              az acr create \
                --resource-group "$RG" \
                --name "$ACR_NAME" \
                --sku Basic \
                --location "$LOC" \
                --admin-enabled false 1>/dev/null
            else
              echo "Resolved ACR_NAME=$ACR_NAME"
            fi

            ACR_LOGIN_SERVER="$(az acr show -g "$RG" -n "$ACR_NAME" --query loginServer -o tsv)"
            echo "ACR_LOGIN_SERVER=$ACR_LOGIN_SERVER"

            echo "AZURE_WEBAPP_NAME_RESOLVED=$WEBAPP" >> "$GITHUB_ENV"
            echo "AZURE_ACR_NAME_RESOLVED=$ACR_NAME" >> "$GITHUB_ENV"
            echo "ACR_LOGIN_SERVER=$ACR_LOGIN_SERVER" >> "$GITHUB_ENV"

            echo ""
            echo "TIP: אם תרצה לקבע משתנים בריפו:"
            echo "  AZURE_WEBAPP_NAME=$WEBAPP"
            echo "  AZURE_ACR_NAME=$ACR_NAME"

      - name: Build and push Docker image (runner -> ACR)
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail

            RG="${AZURE_RESOURCE_GROUP}"
            ACR_NAME="${AZURE_ACR_NAME_RESOLVED}"
            ACR_LOGIN_SERVER="${ACR_LOGIN_SERVER}"

            az acr login -n "$ACR_NAME"

            TAG="${GITHUB_SHA::7}"
            IMAGE="$ACR_LOGIN_SERVER/${IMAGE_REPO}:$TAG"
            IMAGE_LATEST="$ACR_LOGIN_SERVER/${IMAGE_REPO}:latest"

            echo "Building: $IMAGE"
            docker build -t "$IMAGE" -t "$IMAGE_LATEST" .
            docker push "$IMAGE"
            docker push "$IMAGE_LATEST"

            echo "IMAGE_TAG=$TAG" >> "$GITHUB_ENV"

      - name: Configure WebApp to use image + set settings + grant AcrPull
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail

            RG="${AZURE_RESOURCE_GROUP}"
            WEBAPP="${AZURE_WEBAPP_NAME_RESOLVED}"
            ACR_NAME="${AZURE_ACR_NAME_RESOLVED}"
            ACR_LOGIN_SERVER="${ACR_LOGIN_SERVER}"
            TAG="${IMAGE_TAG}"

            IMAGE="$ACR_LOGIN_SERVER/${IMAGE_REPO}:$TAG"
            echo "Deploying image: $IMAGE"
            echo "WEBAPP=$WEBAPP ACR=$ACR_NAME"

            # Enable managed identity for webapp (if not already)
            PRINCIPAL_ID="$(az webapp identity assign -g "$RG" -n "$WEBAPP" --query principalId -o tsv)"
            ACR_ID="$(az acr show -g "$RG" -n "$ACR_NAME" --query id -o tsv)"

            # Grant AcrPull to the webapp identity
            az role assignment create \
              --assignee-object-id "$PRINCIPAL_ID" \
              --assignee-principal-type ServicePrincipal \
              --role AcrPull \
              --scope "$ACR_ID" 1>/dev/null || true

            # Tell WebApp which image to run
            az webapp config container set \
              --resource-group "$RG" \
              --name "$WEBAPP" \
              --docker-custom-image-name "$IMAGE" \
              --docker-registry-server-url "https://$ACR_LOGIN_SERVER"

            # Non-secret settings
            az webapp config appsettings set \
              --resource-group "$RG" \
              --name "$WEBAPP" \
              --settings NODE_ENV=production PORT=8080 WEBSITES_PORT=8080 1>/dev/null

            # Secret settings (from GitHub Secrets)
            az webapp config appsettings set \
              --resource-group "$RG" \
              --name "$WEBAPP" \
              --settings \
                DATABASE_URL="${{ secrets.DATABASE_URL }}" \
                OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
                JWT_SECRET="${{ secrets.JWT_SECRET }}" \
                ROOT_URL="${{ secrets.ROOT_URL }}" \
                GOOGLE_MAPS_API_KEY="${{ secrets.GOOGLE_MAPS_API_KEY }}" 1>/dev/null
            az webapp restart -g "$RG" -n "$WEBAPP"
            echo "Done."

