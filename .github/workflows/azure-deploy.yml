name: Azure - Deploy

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'Dockerfile'
      - '.github/workflows/azure-deploy.yml'
      - 'infra/azure/**'

permissions:
  id-token: write
  contents: read

concurrency:
  group: azure-deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
      AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
      AZURE_WEBAPP_NAME: ${{ vars.AZURE_WEBAPP_NAME }}
      AZURE_ACR_NAME: ${{ vars.AZURE_ACR_NAME }}
      IMAGE_REPO: chocoai

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: |
            backend/package-lock.json
            package-lock.json

      - name: Build backend (dist)
        run: |
          set -euo pipefail
          npm ci --prefix backend
          # Prisma Client generation needs a DATABASE_URL, but we don't need a real DB here.
          DATABASE_URL="postgresql://user:pass@localhost:5432/chocoai?schema=public" npm run db:generate --prefix backend
          npm run build --prefix backend

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID || vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID || vars.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID || vars.AZURE_SUBSCRIPTION_ID }}

      - name: Resolve ACR + WebApp names (auto-discover if missing)
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail

            RG="${AZURE_RESOURCE_GROUP:-}"
            if [ -z "$RG" ]; then
              echo "Missing GitHub variable: AZURE_RESOURCE_GROUP"
              exit 1
            fi

            ACR_NAME="${AZURE_ACR_NAME:-}"
            if [ -z "$ACR_NAME" ]; then
              ACR_NAME="$(az acr list -g "$RG" --query "[?contains(name,'chocoai')]|[0].name" -o tsv)"
              if [ -z "$ACR_NAME" ]; then
                ACR_NAME="$(az acr list -g "$RG" --query "[0].name" -o tsv)"
              fi
            fi
            if [ -z "$ACR_NAME" ]; then
              echo "Could not find any ACR in resource group '$RG'."
              echo "Create ACR or set repo variable AZURE_ACR_NAME."
              exit 1
            fi

            WEBAPP="${AZURE_WEBAPP_NAME:-}"
            if [ -z "$WEBAPP" ]; then
              WEBAPP="$(az webapp list -g "$RG" --query "[?contains(name,'chocoai')]|[0].name" -o tsv)"
              if [ -z "$WEBAPP" ]; then
                WEBAPP="$(az webapp list -g "$RG" --query "[0].name" -o tsv)"
              fi
            fi
            if [ -z "$WEBAPP" ]; then
              echo "Could not find any Web App in resource group '$RG'."
              echo "Create Web App or set repo variable AZURE_WEBAPP_NAME."
              exit 1
            fi

            ACR_LOGIN_SERVER="$(az acr show -g "$RG" -n "$ACR_NAME" --query loginServer -o tsv)"

            echo "Using RG=$RG"
            echo "Using ACR_NAME=$ACR_NAME"
            echo "Using WEBAPP=$WEBAPP"
            echo "Using ACR_LOGIN_SERVER=$ACR_LOGIN_SERVER"

            echo "ACR_NAME=$ACR_NAME" >> "$GITHUB_ENV"
            echo "WEBAPP=$WEBAPP" >> "$GITHUB_ENV"
            echo "ACR_LOGIN_SERVER=$ACR_LOGIN_SERVER" >> "$GITHUB_ENV"

      - name: Build image in ACR (az acr build)
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail

            RG="${AZURE_RESOURCE_GROUP}"
            ACR_NAME="${ACR_NAME}"
            TAG="${GITHUB_SHA::7}"

            echo "Building in ACR: ${ACR_NAME}/${IMAGE_REPO}:${TAG}"
            # Builds remotely inside ACR (no docker needed on runner)
            az acr build \
              -g "$RG" \
              -r "$ACR_NAME" \
              -t "${IMAGE_REPO}:${TAG}" \
              -t "${IMAGE_REPO}:latest" \
              .

            echo "IMAGE_TAG=$TAG" >> "$GITHUB_ENV"

      - name: Ensure WebApp can pull from ACR (Managed Identity + AcrPull)
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail

            RG="${AZURE_RESOURCE_GROUP}"
            WEBAPP="${WEBAPP}"
            ACR_NAME="${ACR_NAME}"

            # Turn on system-assigned identity (safe if already enabled)
            PRINCIPAL_ID="$(az webapp identity assign -g "$RG" -n "$WEBAPP" --query principalId -o tsv)"
            ACR_ID="$(az acr show -g "$RG" -n "$ACR_NAME" --query id -o tsv)"

            # Assign AcrPull role (idempotent-ish; if it already exists, Azure may error -> ignore)
            az role assignment create \
              --assignee-object-id "$PRINCIPAL_ID" \
              --assignee-principal-type ServicePrincipal \
              --role "AcrPull" \
              --scope "$ACR_ID" || true

            echo "WebApp identity principalId=$PRINCIPAL_ID"

      - name: Deploy Web App to new image
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail

            RG="${AZURE_RESOURCE_GROUP}"
            WEBAPP="${WEBAPP}"
            ACR_LOGIN_SERVER="${ACR_LOGIN_SERVER}"
            TAG="${IMAGE_TAG}"

            IMAGE="${ACR_LOGIN_SERVER}/${IMAGE_REPO}:${TAG}"
            echo "Deploying image: $IMAGE"

            # Configure container image
            az webapp config container set \
              --resource-group "$RG" \
              --name "$WEBAPP" \
              --docker-custom-image-name "$IMAGE" \
              --docker-registry-server-url "https://${ACR_LOGIN_SERVER}"

            # Required for Linux container on App Service
            az webapp config appsettings set \
              --resource-group "$RG" \
              --name "$WEBAPP" \
              --settings \
                WEBSITES_PORT=8080 \
                PORT=8080 \
                NODE_ENV=production

            # Secrets from GitHub Secrets
            az webapp config appsettings set \
              --resource-group "$RG" \
              --name "$WEBAPP" \
              --settings \
                DATABASE_URL="${{ secrets.DATABASE_URL }}" \
                OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
                JWT_SECRET="${{ secrets.JWT_SECRET }}" \
                ROOT_URL="${{ secrets.ROOT_URL }}" \
                GOOGLE_MAPS_API_KEY="${{ secrets.GOOGLE_MAPS_API_KEY }}"

            az webapp restart --resource-group "$RG" --name "$WEBAPP"
