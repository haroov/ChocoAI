name: Azure - Deploy

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'Dockerfile'
      - '.github/workflows/azure-deploy.yml'
      - 'infra/azure/**'

permissions:
  id-token: write
  contents: read

concurrency:
  group: azure-deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
      AZURE_WEBAPP_NAME: ${{ vars.AZURE_WEBAPP_NAME }}
      AZURE_ACR_NAME: ${{ vars.AZURE_ACR_NAME }}
      IMAGE_REPO: chocoai

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: backend/package-lock.json

      - name: Build backend
        run: |
          set -e
          npm ci --prefix backend
          DATABASE_URL="postgresql://user:pass@localhost:5432/db" npm run db:generate --prefix backend
          npm run build --prefix backend

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Build and push Docker image
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -e

            RG="$AZURE_RESOURCE_GROUP"
            ACR="$AZURE_ACR_NAME"

            if [ -z "$RG" ]; then
              echo "Missing AZURE_RESOURCE_GROUP"
              exit 1
            fi

            if [ -z "$ACR" ]; then
              echo "Missing AZURE_ACR_NAME"
              exit 1
            fi

            LOGIN_SERVER=$(az acr show -g "$RG" -n "$ACR" --query loginServer -o tsv)
            az acr login -n "$ACR"

            TAG=$(echo $GITHUB_SHA | cut -c1-7)

            IMAGE="$LOGIN_SERVER/${IMAGE_REPO}:$TAG"
            IMAGE_LATEST="$LOGIN_SERVER/${IMAGE_REPO}:latest"

            docker build -t "$IMAGE" -t "$IMAGE_LATEST" .
            docker push "$IMAGE"
            docker push "$IMAGE_LATEST"

            echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Deploy to Web App
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -e

            RG="$AZURE_RESOURCE_GROUP"
            WEBAPP="$AZURE_WEBAPP_NAME"

            if [ -z "$WEBAPP" ]; then
              echo "Missing AZURE_WEBAPP_NAME"
              exit 1
            fi

            az webapp config container set \
              --resource-group "$RG" \
              --name "$WEBAPP" \
              --docker-custom-image-name "$IMAGE"

            az webapp config appsettings set \
              --resource-group "$RG" \
              --name "$WEBAPP" \
              --settings \
                NODE_ENV=production \
                PORT=8080 \
                WEBSITES_PORT=8080 \
                DATABASE_URL="${{ secrets.DATABASE_URL }}" \
                OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
                JWT_SECRET="${{ secrets.JWT_SECRET }}" \
                ROOT_URL="${{ secrets.ROOT_URL }}" \
                GOOGLE_MAPS_API_KEY="${{ secrets.GOOGLE_MAPS_API_KEY }}"

            az webapp restart \
              --resource-group "$RG" \
              --name "$WEBAPP"
