name: Azure - Deploy (enterprise)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'Dockerfile'
      - '.github/workflows/azure-deploy.yml'
      - 'infra/azure/**'

permissions:
  id-token: write
  contents: read

concurrency:
  group: azure-deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
      AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
      AZURE_WEBAPP_NAME: ${{ vars.AZURE_WEBAPP_NAME }}
      AZURE_ACR_NAME: ${{ vars.AZURE_ACR_NAME }}
      AZURE_KEYVAULT_NAME: ${{ vars.AZURE_KEYVAULT_NAME }}
      IMAGE_REPO: chocoai

    steps:
      - uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID || vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID || vars.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID || vars.AZURE_SUBSCRIPTION_ID }}

      - name: Validate required vars
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            for v in AZURE_RESOURCE_GROUP AZURE_WEBAPP_NAME AZURE_ACR_NAME AZURE_KEYVAULT_NAME; do
              if [ -z "${!v:-}" ]; then
                echo "Missing GitHub variable: $v"
                exit 1
              fi
            done

      # Build inside ACR (no docker on runner)
      - name: Build image in ACR (az acr build)
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            RG="$AZURE_RESOURCE_GROUP"
            ACR="$AZURE_ACR_NAME"
            TAG="${GITHUB_SHA::7}"
            IMAGE="$IMAGE_REPO:$TAG"

            echo "Building in ACR: $ACR -> $IMAGE"
            az acr build -r "$ACR" -g "$RG" -t "$IMAGE" -t "$IMAGE_REPO:latest" .

            LOGIN_SERVER="$(az acr show -n "$ACR" -g "$RG" --query loginServer -o tsv)"
            echo "ACR_LOGIN_SERVER=$LOGIN_SERVER" >> $GITHUB_ENV
            echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV

      - name: Ensure WebApp identity + AcrPull (idempotent)
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            RG="$AZURE_RESOURCE_GROUP"
            WEB="$AZURE_WEBAPP_NAME"
            ACR="$AZURE_ACR_NAME"

            # Ensure system identity exists
            az webapp identity assign -g "$RG" -n "$WEB" 1>/dev/null

            PRINCIPAL_ID="$(az webapp identity show -g "$RG" -n "$WEB" --query principalId -o tsv)"
            ACR_ID="$(az acr show -g "$RG" -n "$ACR" --query id -o tsv)"

            # Assign AcrPull (safe if already exists)
            az role assignment create \
              --assignee-object-id "$PRINCIPAL_ID" \
              --assignee-principal-type ServicePrincipal \
              --role AcrPull \
              --scope "$ACR_ID" \
              1>/dev/null || true

      - name: Deploy WebApp to new image (Managed Identity pull)
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            RG="$AZURE_RESOURCE_GROUP"
            WEB="$AZURE_WEBAPP_NAME"
            ACR_SERVER="$ACR_LOGIN_SERVER"
            TAG="$IMAGE_TAG"
            IMAGE="$ACR_SERVER/$IMAGE_REPO:$TAG"

            echo "Deploying image: $IMAGE"

            az webapp config container set \
              -g "$RG" \
              -n "$WEB" \
              --docker-custom-image-name "$IMAGE" \
              --docker-registry-server-url "https://$ACR_SERVER"

            # Try to explicitly enable managed identity for ACR pull (not available in all CLI versions)
            az webapp config set -g "$RG" -n "$WEB" --generic-configurations '{"acrUseManagedIdentityCreds": true}' 1>/dev/null || true

            az webapp config appsettings set \
              -g "$RG" \
              -n "$WEB" \
              --settings NODE_ENV=production PORT=8080 WEBSITES_PORT=8080

      # Secrets to KeyVault (one-time or every deploy). This still needs GitHub secrets ONCE,
      # but after first run you can remove them from GitHub and manage secrets only in KeyVault.
      - name: Sync secrets into KeyVault (optional but recommended)
        if: ${{ secrets.OPENAI_API_KEY != '' }}
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            KV="$AZURE_KEYVAULT_NAME"

            # These write values into KeyVault
            az keyvault secret set --vault-name "$KV" --name "DATABASE-URL" --value "${{ secrets.DATABASE_URL }}"
            az keyvault secret set --vault-name "$KV" --name "OPENAI-API-KEY" --value "${{ secrets.OPENAI_API_KEY }}"
            az keyvault secret set --vault-name "$KV" --name "JWT-SECRET" --value "${{ secrets.JWT_SECRET }}"
            az keyvault secret set --vault-name "$KV" --name "ROOT-URL" --value "${{ secrets.ROOT_URL }}"
            az keyvault secret set --vault-name "$KV" --name "GOOGLE-MAPS-API-KEY" --value "${{ secrets.GOOGLE_MAPS_API_KEY }}"

      - name: Configure WebApp settings via KeyVault references
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            RG="$AZURE_RESOURCE_GROUP"
            WEB="$AZURE_WEBAPP_NAME"
            KV="$AZURE_KEYVAULT_NAME"

            # KeyVault reference syntax
            kvref () {
              echo "@Microsoft.KeyVault(VaultName=$KV;SecretName=$1)"
            }

            az webapp config appsettings set \
              -g "$RG" \
              -n "$WEB" \
              --settings \
                DATABASE_URL="$(kvref DATABASE-URL)" \
                OPENAI_API_KEY="$(kvref OPENAI-API-KEY)" \
                JWT_SECRET="$(kvref JWT-SECRET)" \
                ROOT_URL="$(kvref ROOT-URL)" \
                GOOGLE_MAPS_API_KEY="$(kvref GOOGLE-MAPS-API-KEY)"

            az webapp restart -g "$RG" -n "$WEB"
