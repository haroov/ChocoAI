name: Azure - Provision (enterprise)

on:
  workflow_dispatch:
    inputs:
      location:
        description: Azure region (e.g. israelcentral)
        required: false
        default: israelcentral
      resourceGroupName:
        description: Resource group name
        required: false
        default: rg-chocoai-prod
      webAppName:
        description: Web App name (globally unique)
        required: true
        default: chocoai-prod-web
      acrName:
        description: ACR name (globally unique, lowercase)
        required: true
        default: chocoaiprodacr
      keyVaultName:
        description: KeyVault name (globally unique)
        required: true
        default: chocoai-prod-kv

permissions:
  id-token: write
  contents: read

jobs:
  provision:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID || vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID || vars.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID || vars.AZURE_SUBSCRIPTION_ID }}

      - name: Create RG + Deploy Bicep
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            LOCATION="${{ inputs.location }}"
            RG="${{ inputs.resourceGroupName }}"
            WEBAPP="${{ inputs.webAppName }}"
            ACR="${{ inputs.acrName }}"
            KV="${{ inputs.keyVaultName }}"

            az group create -n "$RG" -l "$LOCATION" 1>/dev/null

            az deployment group create \
              -g "$RG" \
              -n "chocoai-provision-${GITHUB_RUN_ID}" \
              -f "infra/azure/main.bicep" \
              -p location="$LOCATION" webAppName="$WEBAPP" acrName="$ACR" keyVaultName="$KV"

            echo "Provision done."
