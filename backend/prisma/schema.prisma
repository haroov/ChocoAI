// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Conversation {
  id               String             @id @default(cuid())
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  status           String             @default("active")
  lastUserAt       DateTime?
  lastAgentAt      DateTime?
  channel          String             @default("n/a")
  messages         Message[]
  events           Event[]
  apiCalls         ApiCall[]
  state            ConversationState?
  notificationLogs NotificationLog[]
  flowTraces       FlowTrace[]
  qaBugReports     QaBugReport[]

  userId        String?
  user          User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  AIUsage       AIUsage[]
  InsuranceCase InsuranceCase[]

  @@index([createdAt])
  @@index([status])
  @@index([userId])
  @@index([channel])
  @@map("conversations")
}

model QaBugReport {
  id             String   @id @default(cuid())
  conversationId String?
  reporterUserId String?
  status         String   @default("open") // open, triaged, fixed, wontfix
  severity       String // critical, high, medium, low
  type           String // routing, tool, copy, telemetry, extraction, other
  title          String
  expected       String
  actual         String
  reproSteps     String?
  personaTestId  String?
  environment    String?
  debugBundle    Json?
  tags           String[]
  screenshots    String[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([status])
  @@index([createdAt])
  @@map("qa_bug_reports")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  flowId         String?
  role           String // "user" | "assistant" | "system"
  content        String
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  flow           Flow?        @relation(fields: [flowId], references: [id], onDelete: NoAction)
  AIUsage        AIUsage[]

  @@index([conversationId, createdAt])
  @@map("messages")
}

model Event {
  id             String       @id @default(cuid())
  conversationId String
  kind           String // 'timeline' | 'flow' | 'status' | 'note'
  label          String?
  data           Json
  channel        String? // "web" | "whatsapp" | "email"
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([kind])
  @@index([channel])
  @@map("events")
}

model ApiCall {
  id             String       @id @default(cuid())
  conversationId String
  provider       String // 'openai' | 'choco'
  model          String? // e.g., 'gpt-4o-mini'
  service        String? // e.g., 'Choco'
  endpoint       String? // e.g., '/users/profile'
  method         String? // 'GET' | 'POST'
  operation      String // 'signup' | 'verify' | 'extract_fields' | ...
  request        Json
  response       Json?
  status         Int? // HTTP status code
  statusText     String? // 'ok' | 'error' (legacy)
  latencyMs      Int?
  tokensIn       Int?
  tokensOut      Int?
  attempt        Int          @default(1)
  corrId         String?
  runId          String?
  stepRunId      String?
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([provider, operation])
  @@index([corrId, runId])
  @@index([createdAt])
  @@map("api_calls")
}

model ConversationState {
  id                String       @id @default(cuid())
  conversationId    String       @unique
  stage             String
  intentConfirmed   Boolean      @default(false)
  role              String?
  signupStatus      String       @default("pending")
  signupError       String?
  lastPromptedStage String?
  fields            Json?
  timestamps        Json?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  conversation      Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("conversation_state")
}

model ProjectConfig {
  id                    Int      @id @default(1)
  llmProvider           String   @default("openai")
  llmModel              String   @default("gpt-5.2")
  temperature           Float    @default(0.2)
  systemPrompt          String   @default("You are ChocoAI, a helpful assistant for Choco registration.")
  backendMode           String   @default("mock") // 'mock' | 'choco'
  chocoBaseUrl          String   @default("https://api.chocoinsurance.com")
  chocoDashboardBaseUrl String   @default("https://dashboardapi.chocoinsurance.com")
  chocoApiKey           String   @default("")
  rateLimitRps          Int      @default(3)
  features              Json     @default("{\"newRunner\": false, \"mockModeRibbon\": false}")
  updatedAt             DateTime @updatedAt

  @@map("project_config")
}

model Settings {
  id               String   @id @default("global")
  currentVersionId String?
  updatedAt        DateTime @updatedAt

  currentVersion SettingsVersion?  @relation("CurrentVersion", fields: [currentVersionId], references: [id])
  versions       SettingsVersion[] @relation("SettingsVersions")

  @@map("settings")
}

model SettingsVersion {
  id         String   @id @default(cuid())
  settingsId String   @default("global")
  version    Int
  models     Json     @default("{\"primary\": \"gpt-5.2\", \"fallback\": \"gpt-4o\", \"timeoutMs\": 8000, \"retries\": 2, \"stream\": true}")
  flow       Json     @default("{\"retry\": {\"tries\": 3, \"baseDelayMs\": 1000}}")
  features   Json     @default("{\"newRunner\": false, \"parallelSteps\": false, \"mockMode\": false}")
  notes      String? // Optional change description
  createdAt  DateTime @default(now())
  createdBy  String? // Optional user identifier

  settings        Settings   @relation("SettingsVersions", fields: [settingsId], references: [id], onDelete: Cascade)
  currentSettings Settings[] @relation("CurrentVersion")

  @@unique([settingsId, version])
  @@index([settingsId, createdAt])
  @@map("settings_versions")
}

model Memory {
  id        BigInt    @id @default(autoincrement())
  scope     String // 'session'|'user'|'org'
  tenantId  String?
  userId    String?
  sessionId String?
  key       String
  value     Json
  ttlAt     DateTime?
  createdAt DateTime  @default(now())

  @@index([scope, tenantId, userId, sessionId, key], map: "idx_mem_lookup")
  @@index([ttlAt], map: "idx_mem_ttl")
  @@map("memories")
}

model User {
  id             String  @id @default(cuid())
  firstName      String  @default("")
  lastName       String  @default("")
  role           String
  email          String  @default("")
  emailConfirmed Boolean @default(false)
  registered     Boolean @default(false)

  conversations         Conversation[]
  data                  UserData[]
  tokens                Tokens[]
  UserFlow              UserFlow[]
  FlowHistory           FlowHistory[]
  UserOrganisation      UserOrganisation[]
  customerAccess        CustomerUser[]
  createdInsuranceCases InsuranceCase[]    @relation("InsuranceCaseCreatedBy")
  InsuranceIntake       InsuranceIntake[]

  @@index([email])
  @@map("users")
}

model UserData {
  id     String  @id @default(cuid())
  userId String
  flowId String
  key    String
  value  String?
  type   String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  flow Flow @relation(fields: [flowId], references: [id], onDelete: Cascade)

  @@unique([key, userId, flowId])
  @@index([key])
  @@map("user_data")
}

model Tokens {
  id        String   @id @default(cuid())
  value     String
  userId    String
  type      String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
  @@map("tokens")
}

model Flow {
  id          String        @id @default(cuid())
  name        String
  slug        String
  version     Int           @default(1)
  description String
  definition  Json
  createdAt   DateTime      @default(now())
  UserFlow    UserFlow[]
  UserData    UserData[]
  Message     Message[]
  FlowHistory FlowHistory[]

  @@unique([slug])
  @@index([slug])
  @@map("flows")
}

model Tool {
  id          String   @id @default(cuid())
  name        String   @unique
  description String
  code        String // JavaScript/TypeScript code for tool executor
  metadata    Json // Tool metadata (parameters, return type, etc.)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("tools")
}

model UserFlow {
  id     String @id @default(cuid())
  userId String
  flowId String
  stage  String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  flow Flow @relation(fields: [flowId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@index([userId])
  @@map("user_flow")
}

model FlowHistory {
  id          String   @id @default(cuid())
  userId      String
  flowId      String
  stage       String
  sessionId   String
  completedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  flow Flow @relation(fields: [flowId], references: [id], onDelete: Cascade)

  @@index([userId, flowId])
  @@index([userId])
  @@map("flow_history")
}

model FlowTrace {
  id                String    @id @default(cuid())
  conversationId    String
  flowSlug          String
  stageSlug         String
  enteredAt         DateTime  @default(now())
  completedAt       DateTime?
  fieldsCollected   String[] // Array of field slugs
  toolsExecuted     Json[] // Array of { toolName, success, error?, timestamp }
  errorsEncountered Json[] // Array of { error, stage, toolName, timestamp }
  userDataSnapshot  Json? // userData at stage entry

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([flowSlug, stageSlug])
  @@index([enteredAt])
  @@map("flow_traces")
}

model AIUsage {
  id             String   @id @default(cuid())
  provider       String
  model          String
  operationType  String
  inputTokens    Int
  outputTokens   Int
  latencyMs      Int
  conversationId String
  inReplyTo      String
  cost           Decimal  @db.Decimal(10, 6)
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: NoAction)
  message      Message      @relation(fields: [inReplyTo], references: [id], onDelete: NoAction)

  @@map("ai_usage")
}

model Admin {
  id           String    @id @default(cuid())
  username     String    @unique
  passwordHash String
  role         String    @default("admin")
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("admins")
}

model AuthToken {
  id        String   @id @default(uuid(4))
  target    String
  value     String
  createdAt DateTime @default(now())

  @@unique([target])
  @@index([target])
  @@map("auth_tokens")
}

model OrganisationInfo {
  id               String             @id @default(uuid(4))
  einOrRegNum      String
  region           String
  data             Json
  UserOrganisation UserOrganisation[]

  @@unique([einOrRegNum, region])
  @@index([einOrRegNum, region])
  @@index([einOrRegNum])
  @@map("organisation_info")
}

model UserOrganisation {
  id             String @id @default(uuid(4))
  userId         String
  organisationId String

  user         User             @relation(fields: [userId], references: [id])
  organisation OrganisationInfo @relation(fields: [organisationId], references: [id])

  @@unique([userId, organisationId])
  @@map("user_organisation")
}

model NotificationLog {
  id             String   @id @default(cuid())
  conversationId String
  channel        String // 'email' | 'sms'
  templateId     String
  to             String
  success        Boolean
  messageId      String?
  error          String?
  provider       String // 'sendgrid', 'twilio', etc.
  idempotencyKey String?
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@index([idempotencyKey])
  @@map("notification_logs")
}

enum LegalIdType {
  HP // ח.פ
  AM // ע.מ
  TZ // ת.ז
  EIN
}

enum CustomerAccessRole {
  owner
  admin
  viewer
}

enum InsuranceCaseStatus {
  draft
  collectingInfo
  submittedToCarrier
  awaitingCarrier
  awaitingCustomer
  issued
  cancelled
}

enum InsuranceCoverageType {
  structure
  contents
  thirdParty
  employersLiability
  specialRisks
  professionalLiability
  paramedical
  productLiability
  other
}

enum InsuranceRequirementStatus {
  needed
  requested
  received
  approved
  rejected
}

enum InsuranceRequirementRequestedBy {
  broker
  carrier
}

enum EmailDirection {
  inbound
  outbound
}

enum EmailProvider {
  mailgun
  sendgrid
  other
}

enum PdfDocumentStatus {
  draft
  generated
  sentToCarrier
  sentToCustomer
  receivedFromCarrier
  archived
}

model Customer {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  displayName String
  legalIdType LegalIdType
  legalId     String
  country     String      @default("IL")

  industry    String?
  addressJson Json?
  notes       String?

  users  CustomerUser[]
  cases  InsuranceCase[]
  emails EmailMessage[]

  @@unique([legalIdType, legalId, country])
  @@index([legalIdType, legalId])
  @@map("customers")
}

model CustomerUser {
  customerId String
  userId     String
  accessRole CustomerAccessRole @default(owner)
  createdAt  DateTime           @default(now())

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([customerId, userId])
  @@index([userId])
  @@map("customer_users")
}

model InsuranceCarrier {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name          String
  slug          String   @unique
  contactEmails String[]
  inboundMatch  Json?

  cases         InsuranceCase[]
  emailMessages EmailMessage[]
  pdfTemplates  PdfTemplate[]

  @@map("insurance_carriers")
}

model InsuranceCase {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  status  InsuranceCaseStatus @default(draft)
  summary String?

  customerId      String
  carrierId       String
  conversationId  String?
  createdByUserId String?
  latestIntakeId  String?

  customer     Customer         @relation(fields: [customerId], references: [id], onDelete: Restrict)
  carrier      InsuranceCarrier @relation(fields: [carrierId], references: [id], onDelete: Restrict)
  conversation Conversation?    @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  createdBy    User?            @relation("InsuranceCaseCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  latestIntake InsuranceIntake? @relation("LatestIntake", fields: [latestIntakeId], references: [id], onDelete: SetNull)

  coverages    InsuranceCoverage[]
  requirements InsuranceRequirement[]
  emails       EmailMessage[]
  pdfDocuments PdfDocument[]
  intakes      InsuranceIntake[]      @relation("CaseIntakes")

  @@index([customerId, status])
  @@index([carrierId, status])
  @@index([conversationId])
  @@index([latestIntakeId])
  @@map("insurance_cases")
}

model InsuranceIntake {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  caseId          String
  schemaId        String
  version         Int
  payload         Json
  source          String?
  createdByUserId String?

  insuranceCase  InsuranceCase   @relation("CaseIntakes", fields: [caseId], references: [id], onDelete: Cascade)
  createdBy      User?           @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)
  latestForCases InsuranceCase[] @relation("LatestIntake")

  @@unique([caseId, version])
  @@index([caseId, createdAt])
  @@index([schemaId])
  @@map("insurance_intakes")
}

model InsuranceCoverage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  caseId       String
  coverageType InsuranceCoverageType
  details      Json                  @default("{}")
  sumInsured   Decimal?              @db.Decimal(14, 2)
  deductible   Decimal?              @db.Decimal(14, 2)
  currency     String                @default("ILS")

  insuranceCase InsuranceCase @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId, coverageType])
  @@map("insurance_coverages")
}

model InsuranceRequirement {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  caseId      String
  key         String
  description String
  status      InsuranceRequirementStatus      @default(needed)
  requestedBy InsuranceRequirementRequestedBy @default(broker)
  dueAt       DateTime?
  metadata    Json?

  insuranceCase InsuranceCase @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@unique([caseId, key])
  @@index([caseId, status])
  @@map("insurance_requirements")
}

model EmailMessage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  direction EmailDirection
  provider  EmailProvider

  providerMessageId String? // Message-ID
  inReplyTo         String?
  references        String[]
  threadKey         String?

  from       String
  to         String[]
  cc         String[]
  subject    String
  bodyText   String?
  bodyHtml   String?
  rawPayload Json?

  matchedLegalIdType LegalIdType?
  matchedLegalId     String?

  carrierId  String?
  customerId String?
  caseId     String?

  carrier       InsuranceCarrier? @relation(fields: [carrierId], references: [id], onDelete: SetNull)
  customer      Customer?         @relation(fields: [customerId], references: [id], onDelete: SetNull)
  insuranceCase InsuranceCase?    @relation(fields: [caseId], references: [id], onDelete: SetNull)
  attachments   EmailAttachment[]

  @@index([provider, providerMessageId])
  @@index([caseId, createdAt])
  @@index([customerId, createdAt])
  @@index([carrierId, createdAt])
  @@index([threadKey])
  @@map("email_messages")
}

model EmailAttachment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  emailMessageId String
  filename       String
  mimeType       String
  sizeBytes      Int
  sha256         String
  content        Bytes

  emailMessage EmailMessage @relation(fields: [emailMessageId], references: [id], onDelete: Cascade)

  @@index([emailMessageId])
  @@index([sha256])
  @@map("email_attachments")
}

model PdfTemplate {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  carrierId    String?
  name         String
  version      Int     @default(1)
  fileBytes    Bytes
  fieldMapping Json    @default("{}")
  active       Boolean @default(true)

  carrier   InsuranceCarrier? @relation(fields: [carrierId], references: [id], onDelete: SetNull)
  documents PdfDocument[]

  @@unique([carrierId, name, version])
  @@index([carrierId, active])
  @@map("pdf_templates")
}

model PdfDocument {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  caseId     String
  templateId String?
  status     PdfDocumentStatus @default(draft)

  fileName  String
  mimeType  String @default("application/pdf")
  sizeBytes Int
  sha256    String
  fileBytes Bytes

  insuranceCase InsuranceCase @relation(fields: [caseId], references: [id], onDelete: Cascade)
  template      PdfTemplate?  @relation(fields: [templateId], references: [id], onDelete: SetNull)

  @@index([caseId, createdAt])
  @@index([templateId])
  @@index([sha256])
  @@map("pdf_documents")
}
