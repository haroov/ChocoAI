{
    "name": "ChocoAI Digital Insurance Agent Flows",
    "version": "1.0.0",
    "notes": [
        "Field names are in English; user-facing content may be Hebrew.",
        "Dates must be ISO-8601 (YYYY-MM-DD) or ISO datetime (YYYY-MM-DDTHH:MM:SSZ).",
        "Amounts (sums insured, deductibles, premiums, limits) are numbers.",
        "Decision logic / comments should be stored in notes[] / rules_applied[].",
        "This is a declarative flow-engine style: flows -> stages -> transitions + validations + actions."
    ],
    "flows": {
        "welcome": {
            "type": "router",
            "flowConfig": {
                "defaultForNewUsers": true,
                "initialStage": "route",
                "successStage": "routed",
                "errorStage": "route_retry"
            },
            "fieldDefinitions": {
                "intent_type": {
                    "type": "string",
                    "enum": [
                        "identify",
                        "policy_existence_confirmation",
                        "quote",
                        "continue",
                        "support"
                    ]
                },
                "intent_confidence": {
                    "type": "number",
                    "minimum": 0,
                    "maximum": 1
                },
                "needs_account_confirmation": {
                    "type": "boolean"
                },
                "confirmation_asked": {
                    "type": "boolean"
                },
                "welcome_intent_gate_reason": {
                    "type": "string"
                },
                "active_quote_id": {
                    "type": [
                        "string",
                        "null"
                    ]
                },
                "has_in_progress_quote": {
                    "type": "boolean"
                }
            },
            "stages": {
                "route": {
                    "type": "prompt",
                    "prompt": "welcome/route.md",
                    "fields": [
                        "intent_type",
                        "intent_confidence",
                        "needs_account_confirmation",
                        "confirmation_asked",
                        "welcome_intent_gate_reason"
                    ],
                    "validation": {
                        "required": [
                            "intent_type"
                        ]
                    },
                    "transitions": {
                        "identify": {
                            "startFlowSlug": "identifyCustomer",
                            "mode": "seamless"
                        },
                        "policy_existence_confirmation": {
                            "startFlowSlug": "policyExistenceConfirmation",
                            "mode": "seamless"
                        },
                        "quote": {
                            "startFlowSlug": "needsDiscovery",
                            "mode": "seamless"
                        },
                        "continue": {
                            "startFlowSlug": "needsDiscovery",
                            "mode": "seamless"
                        },
                        "support": {
                            "startFlowSlug": "support",
                            "mode": "seamless"
                        }
                    }
                },
                "routed": {
                    "type": "terminal"
                },
                "route_retry": {
                    "type": "prompt",
                    "prompt": "welcome/retry.md",
                    "transitions": {
                        "retry": "route"
                    }
                }
            }
        },
        "policyExistenceConfirmation": {
            "type": "service",
            "flowConfig": {
                "initialStage": "collectIdentifier",
                "successStage": "coi_done",
                "errorStage": "coi_retry"
            },
            "fieldDefinitions": {
                "login_identifier": {
                    "type": "string",
                    "description": "Mobile phone (preferred) for OTP"
                },
                "verification_code": {
                    "type": "string"
                },
                "customer_id": {
                    "type": [
                        "string",
                        "null"
                    ]
                },
                "is_existing_customer": {
                    "type": "boolean"
                },
                "has_existing_policy": {
                    "type": "boolean"
                },
                "policy_id": {
                    "type": [
                        "string",
                        "null"
                    ]
                },
                "coi_recipient": {
                    "type": [
                        "string",
                        "null"
                    ],
                    "description": "Who the COI is issued for (recipient/entity)."
                },
                "coi_notes": {
                    "type": [
                        "string",
                        "null"
                    ]
                },
                "coi_pdf_ref": {
                    "type": [
                        "string",
                        "null"
                    ]
                }
            },
            "stages": {
                "collectIdentifier": {
                    "type": "prompt",
                    "prompt": "coi/collectIdentifier.md",
                    "fields": [
                        "login_identifier"
                    ],
                    "validation": {
                        "required": [
                            "login_identifier"
                        ]
                    },
                    "transitions": {
                        "next": "sendOtp"
                    }
                },
                "sendOtp": {
                    "type": "action",
                    "action": {
                        "toolName": "choco.auth.sendOtp",
                        "input": {
                            "login_identifier": "{login_identifier}"
                        },
                        "onError": {
                            "behavior": "stay",
                            "message": "Failed to send OTP. Retry or change identifier."
                        }
                    },
                    "transitions": {
                        "sent": "verifyOtp"
                    }
                },
                "verifyOtp": {
                    "type": "prompt+action",
                    "prompt": "coi/verifyOtp.md",
                    "fields": [
                        "verification_code"
                    ],
                    "validation": {
                        "required": [
                            "verification_code"
                        ]
                    },
                    "action": {
                        "toolName": "choco.auth.verifyOtp",
                        "input": {
                            "login_identifier": "{login_identifier}",
                            "verification_code": "{verification_code}"
                        },
                        "saveResults": {
                            "customer_id": "{result.customer_id}",
                            "is_existing_customer": "{result.is_existing_customer}"
                        },
                        "onError": {
                            "behavior": "stay",
                            "message": "Verification failed. Re-enter code or resend."
                        }
                    },
                    "transitions": {
                        "verified": "checkPolicyEligibility"
                    }
                },
                "checkPolicyEligibility": {
                    "type": "action",
                    "action": {
                        "toolName": "choco.policies.checkEligibilityForCoi",
                        "input": {
                            "customer_id": "{customer_id}",
                            "is_existing_customer": "{is_existing_customer}"
                        },
                        "saveResults": {
                            "has_existing_policy": "{result.has_existing_policy}",
                            "policy_id": "{result.policy_id}"
                        },
                        "onError": {
                            "behavior": "newStage",
                            "nextStage": "handoffToNeedsDiscovery",
                            "message": "Couldn't verify policy eligibility."
                        }
                    },
                    "transitions": {
                        "eligible": "collectCoiDetails",
                        "no_policy": "handoffToNeedsDiscovery",
                        "not_customer": "handoffToRegister"
                    }
                },
                "collectCoiDetails": {
                    "type": "prompt",
                    "prompt": "coi/collectCoiDetails.md",
                    "fields": [
                        "coi_recipient",
                        "coi_notes"
                    ],
                    "validation": {
                        "required": [
                            "coi_recipient"
                        ]
                    },
                    "transitions": {
                        "next": "generateCoi"
                    }
                },
                "generateCoi": {
                    "type": "action",
                    "action": {
                        "toolName": "choco.policies.generateCoiPdf",
                        "input": {
                            "customer_id": "{customer_id}",
                            "policy_id": "{policy_id}",
                            "recipient": "{coi_recipient}",
                            "notes": "{coi_notes}"
                        },
                        "saveResults": {
                            "coi_pdf_ref": "{result.pdf_ref}"
                        },
                        "onError": {
                            "behavior": "stay",
                            "message": "Couldn't generate COI. Retry."
                        }
                    },
                    "transitions": {
                        "generated": "deliverCoi"
                    }
                },
                "deliverCoi": {
                    "type": "action",
                    "action": {
                        "toolName": "choco.notifications.deliverCoi",
                        "input": {
                            "customer_id": "{customer_id}",
                            "pdf_ref": "{coi_pdf_ref}"
                        },
                        "onError": {
                            "behavior": "stay",
                            "message": "Couldn't deliver COI. Retry."
                        }
                    },
                    "transitions": {
                        "delivered": "coi_done"
                    }
                },
                "handoffToNeedsDiscovery": {
                    "type": "terminal",
                    "config": {
                        "onComplete": {
                            "startFlowSlug": "needsDiscovery",
                            "mode": "seamless"
                        }
                    }
                },
                "handoffToRegister": {
                    "type": "terminal",
                    "config": {
                        "onComplete": {
                            "startFlowSlug": "registerCustomer",
                            "mode": "seamless"
                        }
                    }
                },
                "coi_done": {
                    "type": "terminal"
                },
                "coi_retry": {
                    "type": "prompt",
                    "prompt": "coi/retry.md",
                    "transitions": {
                        "retry": "collectIdentifier"
                    }
                }
            }
        },
        "registerCustomer": {
            "type": "onboarding",
            "flowConfig": {
                "initialStage": "collectContact",
                "successStage": "registered",
                "errorStage": "register_retry"
            },
            "fieldDefinitions": {
                "first_name": {
                    "type": "string"
                },
                "last_name": {
                    "type": "string"
                },
                "phone": {
                    "type": "string"
                },
                "email": {
                    "type": [
                        "string",
                        "null"
                    ]
                },
                "address": {
                    "type": [
                        "object",
                        "null"
                    ]
                },
                "customer_id": {
                    "type": [
                        "string",
                        "null"
                    ]
                }
            },
            "stages": {
                "collectContact": {
                    "type": "prompt",
                    "prompt": "register/collectContact.md",
                    "fields": [
                        "first_name",
                        "last_name",
                        "phone",
                        "email",
                        "address"
                    ],
                    "validation": {
                        "required": [
                            "first_name",
                            "last_name",
                            "phone"
                        ]
                    },
                    "transitions": {
                        "next": "createCustomer"
                    }
                },
                "createCustomer": {
                    "type": "action",
                    "action": {
                        "toolName": "choco.customer.register",
                        "input": {
                            "first_name": "{first_name}",
                            "last_name": "{last_name}",
                            "phone": "{phone}",
                            "email": "{email}",
                            "address": "{address}"
                        },
                        "saveResults": {
                            "customer_id": "{result.customer_id}"
                        },
                        "onError": {
                            "behavior": "stay",
                            "message": "Registration failed. Please retry."
                        }
                    },
                    "transitions": {
                        "created": "registered"
                    }
                },
                "registered": {
                    "type": "terminal",
                    "config": {
                        "onComplete": {
                            "startFlowSlug": "needsDiscovery",
                            "mode": "seamless"
                        }
                    }
                },
                "register_retry": {
                    "type": "prompt",
                    "prompt": "register/retry.md",
                    "transitions": {
                        "retry": "collectContact"
                    }
                }
            }
        },
        "identifyCustomer": {
            "type": "service",
            "flowConfig": {
                "initialStage": "collectIdentifier",
                "successStage": "identify_complete",
                "errorStage": "identify_retry"
            },
            "fieldDefinitions": {
                "login_identifier": {
                    "type": "string",
                    "description": "Phone or email for OTP"
                },
                "verification_code": {
                    "type": "string"
                },
                "first_name": {
                    "type": "string"
                },
                "last_name": {
                    "type": "string"
                },
                "phone": {
                    "type": [
                        "string",
                        "null"
                    ]
                },
                "email": {
                    "type": [
                        "string",
                        "null"
                    ]
                },
                "address": {
                    "type": [
                        "object",
                        "null"
                    ]
                },
                "customer_id": {
                    "type": [
                        "string",
                        "null"
                    ]
                },
                "is_existing_customer": {
                    "type": "boolean"
                },
                "last_auth_error_code": {
                    "type": [
                        "string",
                        "null"
                    ]
                }
            },
            "stages": {
                "collectIdentifier": {
                    "type": "prompt",
                    "prompt": "identify/collectIdentifier.md",
                    "fields": [
                        "login_identifier"
                    ],
                    "validation": {
                        "required": [
                            "login_identifier"
                        ]
                    },
                    "transitions": {
                        "next": "sendOtp"
                    }
                },
                "sendOtp": {
                    "type": "action",
                    "action": {
                        "toolName": "choco.auth.sendOtp",
                        "input": {
                            "login_identifier": "{login_identifier}"
                        },
                        "onError": {
                            "behavior": "stay",
                            "message": "Failed to send OTP. Retry or change identifier."
                        }
                    },
                    "transitions": {
                        "sent": "verifyOtp"
                    }
                },
                "verifyOtp": {
                    "type": "prompt+action",
                    "prompt": "identify/verifyOtp.md",
                    "fields": [
                        "verification_code"
                    ],
                    "validation": {
                        "required": [
                            "verification_code"
                        ]
                    },
                    "action": {
                        "toolName": "choco.auth.verifyOtp",
                        "input": {
                            "login_identifier": "{login_identifier}",
                            "verification_code": "{verification_code}"
                        },
                        "saveResults": {
                            "customer_id": "{result.customer_id}",
                            "is_existing_customer": "{result.is_existing_customer}"
                        },
                        "onError": {
                            "behavior": "stay",
                            "message": "Verification failed. Re-enter code or resend."
                        }
                    },
                    "transitions": {
                        "verified": "collectIdentity"
                    }
                },
                "collectIdentity": {
                    "type": "prompt",
                    "prompt": "identify/collectIdentity.md",
                    "fields": [
                        "first_name",
                        "last_name",
                        "phone",
                        "email",
                        "address"
                    ],
                    "validation": {
                        "required": [
                            "first_name",
                            "last_name"
                        ]
                    },
                    "transitions": {
                        "next": "identify_complete"
                    }
                },
                "identify_complete": {
                    "type": "terminal",
                    "config": {
                        "onComplete": {
                            "startFlowSlug": "needsDiscovery",
                            "mode": "seamless"
                        }
                    }
                },
                "identify_retry": {
                    "type": "prompt",
                    "prompt": "identify/retry.md",
                    "transitions": {
                        "retry": "collectIdentifier"
                    }
                }
            }
        },
        "needsDiscovery": {
            "type": "service",
            "flowConfig": {
                "initialStage": "productSelection",
                "successStage": "triage_complete",
                "errorStage": "triage_retry"
            },
            "fieldDefinitions": {
                "product_line": {
                    "type": "string",
                    "enum": [
                        "business_package",
                        "para_medical_pi",
                        "cyber"
                    ]
                },
                "business_name": {
                    "type": "string"
                },
                "legal_entity_type": {
                    "type": "string",
                    "enum": [
                        "company",
                        "authorized_dealer",
                        "exempt_dealer",
                        "partnership",
                        "nonprofit"
                    ]
                },
                "registration_id": {
                    "type": [
                        "string",
                        "null"
                    ]
                },
                "industry": {
                    "type": "string"
                },
                "activity_description": {
                    "type": "string"
                },
                "annual_turnover_ils": {
                    "type": "number",
                    "minimum": 0
                },
                "annual_payroll_ils": {
                    "type": [
                        "number",
                        "null"
                    ],
                    "minimum": 0
                },
                "employees_count": {
                    "type": "integer",
                    "minimum": 0
                },
                "locations_count": {
                    "type": "integer",
                    "minimum": 1
                },
                "has_multiple_locations": {
                    "type": "boolean"
                },
                "coverages_requested": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                },
                "limits_requested": {
                    "type": "object"
                },
                "deductible_preference_ils": {
                    "type": [
                        "number",
                        "null"
                    ],
                    "minimum": 0
                },
                "prior_claims_last_5y": {
                    "type": "boolean"
                },
                "prior_claims_notes": {
                    "type": [
                        "string",
                        "null"
                    ]
                },
                "uw_risk_level": {
                    "type": "string",
                    "enum": [
                        "low",
                        "medium",
                        "high"
                    ]
                },
                "required_form_schema": {
                    "type": "string"
                }
            },
            "stages": {
                "productSelection": {
                    "type": "prompt",
                    "prompt": "needs/productSelection.md",
                    "fields": [
                        "product_line"
                    ],
                    "validation": {
                        "required": [
                            "product_line"
                        ]
                    },
                    "transitions": {
                        "next": "collectCoreBusiness"
                    }
                },
                "collectCoreBusiness": {
                    "type": "prompt",
                    "prompt": "needs/collectCoreBusiness.md",
                    "fields": [
                        "business_name",
                        "legal_entity_type",
                        "registration_id",
                        "industry",
                        "activity_description",
                        "annual_turnover_ils",
                        "annual_payroll_ils",
                        "employees_count",
                        "locations_count",
                        "has_multiple_locations"
                    ],
                    "validation": {
                        "required": [
                            "business_name",
                            "legal_entity_type",
                            "industry",
                            "annual_turnover_ils",
                            "employees_count",
                            "locations_count"
                        ]
                    },
                    "transitions": {
                        "next": "collectCoveragePreferences"
                    }
                },
                "collectCoveragePreferences": {
                    "type": "prompt",
                    "prompt": "needs/collectCoveragePreferences.md",
                    "fields": [
                        "coverages_requested",
                        "limits_requested",
                        "deductible_preference_ils"
                    ],
                    "validation": {
                        "required": [
                            "coverages_requested"
                        ]
                    },
                    "transitions": {
                        "next": "triage"
                    }
                },
                "triage": {
                    "type": "prompt",
                    "prompt": "needs/triage.md",
                    "fields": [
                        "prior_claims_last_5y",
                        "prior_claims_notes"
                    ],
                    "validation": {
                        "required": [
                            "prior_claims_last_5y"
                        ]
                    },
                    "transitions": {
                        "next": "triage_complete"
                    }
                },
                "triage_complete": {
                    "type": "terminal",
                    "config": {
                        "computed": {
                            "required_form_schema": "switch(product_line){business_package:'clal_business_proposal';para_medical_pi:'para_medical_pi_proposal';cyber:'cyber_proposal'}",
                            "uw_risk_level": "triageRiskScore(userData)"
                        },
                        "onComplete": {
                            "startFlowSlug": "proposalForm",
                            "mode": "seamless"
                        }
                    }
                },
                "triage_retry": {
                    "type": "prompt",
                    "prompt": "needs/retry.md",
                    "transitions": {
                        "retry": "productSelection"
                    }
                }
            }
        },
        "proposalForm": {
            "type": "onboarding",
            "flowConfig": {
                "initialStage": "selectSchema",
                "successStage": "proposal_finalized",
                "errorStage": "proposal_retry"
            },
            "fieldDefinitions": {
                "form_schema": {
                    "type": "string"
                },
                "proposal_raw": {
                    "type": "object"
                },
                "proposal_normalized": {
                    "type": "object"
                },
                "rules_applied": {
                    "type": "array",
                    "items": {
                        "type": "object"
                    }
                },
                "notes": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                },
                "proposal_pdf": {
                    "type": [
                        "string",
                        "null"
                    ]
                },
                "proposal_confirmed": {
                    "type": "boolean"
                }
            },
            "stages": {
                "selectSchema": {
                    "type": "action",
                    "action": {
                        "toolName": "choco.forms.selectSchema",
                        "input": {
                            "schema_hint": "{required_form_schema}"
                        },
                        "saveResults": {
                            "form_schema": "{result.schema_slug}"
                        },
                        "onError": {
                            "behavior": "stay",
                            "message": "Failed to select schema. Retry."
                        }
                    },
                    "transitions": {
                        "selected": "collectSections"
                    }
                },
                "collectSections": {
                    "type": "prompt",
                    "prompt": "proposal/collectSections.md",
                    "fields": [
                        "proposal_raw"
                    ],
                    "validation": {
                        "required": [
                            "proposal_raw"
                        ]
                    },
                    "transitions": {
                        "next": "validateAndNormalize"
                    }
                },
                "validateAndNormalize": {
                    "type": "action",
                    "action": {
                        "toolName": "choco.forms.validateAndNormalize",
                        "input": {
                            "schema": "{form_schema}",
                            "proposal_raw": "{proposal_raw}"
                        },
                        "saveResults": {
                            "proposal_normalized": "{result.proposal_normalized}",
                            "rules_applied": "{result.rules_applied}",
                            "notes": "{result.notes}"
                        },
                        "onError": {
                            "behavior": "newStage",
                            "nextStage": "collectSections",
                            "message": "Missing/invalid fields. Please fix."
                        }
                    },
                    "transitions": {
                        "ok": "proposalReview"
                    }
                },
                "proposalReview": {
                    "type": "prompt",
                    "prompt": "proposal/review.md",
                    "fields": [
                        "proposal_confirmed"
                    ],
                    "validation": {
                        "required": [
                            "proposal_confirmed"
                        ]
                    },
                    "transitions": {
                        "confirm": "generateProposalPdf",
                        "edit": "collectSections"
                    }
                },
                "generateProposalPdf": {
                    "type": "action",
                    "action": {
                        "toolName": "choco.docs.generateProposalPdf",
                        "input": {
                            "proposal_normalized": "{proposal_normalized}",
                            "schema": "{form_schema}"
                        },
                        "saveResults": {
                            "proposal_pdf": "{result.pdf_ref}"
                        },
                        "onError": {
                            "behavior": "stay",
                            "message": "Couldn't generate PDF. Retry."
                        }
                    },
                    "transitions": {
                        "generated": "proposal_finalized"
                    }
                },
                "proposal_finalized": {
                    "type": "terminal",
                    "config": {
                        "onComplete": {
                            "startFlowSlug": "carrierSubmission",
                            "mode": "seamless"
                        }
                    }
                },
                "proposal_retry": {
                    "type": "prompt",
                    "prompt": "proposal/retry.md",
                    "transitions": {
                        "retry": "collectSections"
                    }
                }
            }
        },
        "carrierSubmission": {
            "type": "service",
            "flowConfig": {
                "initialStage": "preparePayloads",
                "successStage": "submitted",
                "errorStage": "submission_retry"
            },
            "fieldDefinitions": {
                "carriers": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                },
                "carrier_payloads": {
                    "type": "array",
                    "items": {
                        "type": "object"
                    }
                },
                "carrier_submissions": {
                    "type": "array",
                    "items": {
                        "type": "object"
                    }
                },
                "submission_status": {
                    "type": "string",
                    "enum": [
                        "pending",
                        "sent",
                        "failed"
                    ]
                }
            },
            "stages": {
                "preparePayloads": {
                    "type": "action",
                    "action": {
                        "toolName": "choco.carriers.preparePayloads",
                        "input": {
                            "proposal_normalized": "{proposal_normalized}",
                            "product_line": "{product_line}"
                        },
                        "saveResults": {
                            "carriers": "{result.carriers}",
                            "carrier_payloads": "{result.payloads}"
                        },
                        "onError": {
                            "behavior": "stay",
                            "message": "Failed preparing carrier payloads."
                        }
                    },
                    "transitions": {
                        "prepared": "submitToCarriers"
                    }
                },
                "submitToCarriers": {
                    "type": "action",
                    "action": {
                        "toolName": "choco.carriers.submit",
                        "input": {
                            "payloads": "{carrier_payloads}",
                            "attachments": [
                                "{proposal_pdf}"
                            ]
                        },
                        "saveResults": {
                            "carrier_submissions": "{result.submissions}",
                            "submission_status": "sent"
                        },
                        "onError": {
                            "behavior": "stay",
                            "message": "Submission failed. Retry or switch carrier."
                        }
                    },
                    "transitions": {
                        "sent": "submitted"
                    }
                },
                "submitted": {
                    "type": "terminal",
                    "config": {
                        "onComplete": {
                            "startFlowSlug": "underwritingReview",
                            "mode": "seamless"
                        }
                    }
                },
                "submission_retry": {
                    "type": "prompt",
                    "prompt": "submission/retry.md",
                    "transitions": {
                        "retry": "preparePayloads"
                    }
                }
            }
        },
        "underwritingReview": {
            "type": "service",
            "flowConfig": {
                "initialStage": "awaitCarrierResponse",
                "successStage": "ready_for_payment",
                "errorStage": "uw_retry"
            },
            "fieldDefinitions": {
                "carrier_questions": {
                    "type": "array",
                    "items": {
                        "type": "object"
                    }
                },
                "draft_policy_ref": {
                    "type": [
                        "string",
                        "null"
                    ]
                },
                "quote": {
                    "type": [
                        "object",
                        "null"
                    ]
                },
                "premium_ils": {
                    "type": [
                        "number",
                        "null"
                    ]
                },
                "quote_valid_until": {
                    "type": [
                        "string",
                        "null"
                    ],
                    "format": "date"
                },
                "uw_status": {
                    "type": "string",
                    "enum": [
                        "pending",
                        "questions",
                        "quoted",
                        "declined"
                    ]
                }
            },
            "stages": {
                "awaitCarrierResponse": {
                    "type": "action",
                    "action": {
                        "toolName": "choco.carriers.pollUpdates",
                        "input": {
                            "carrier_submissions": "{carrier_submissions}"
                        },
                        "saveResults": {
                            "uw_status": "{result.uw_status}",
                            "carrier_questions": "{result.questions}",
                            "draft_policy_ref": "{result.draft_policy_ref}",
                            "quote": "{result.quote}",
                            "premium_ils": "{result.premium_ils}",
                            "quote_valid_until": "{result.quote_valid_until}"
                        }
                    },
                    "transitions": {
                        "questions": "collectAnswers",
                        "quoted": "presentQuote",
                        "declined": "declined"
                    }
                },
                "collectAnswers": {
                    "type": "prompt",
                    "prompt": "uw/collectAnswers.md",
                    "fields": [
                        "carrier_questions"
                    ],
                    "validation": {
                        "required": [
                            "carrier_questions"
                        ]
                    },
                    "transitions": {
                        "submit": "submitAnswers"
                    }
                },
                "submitAnswers": {
                    "type": "action",
                    "action": {
                        "toolName": "choco.carriers.submitAnswers",
                        "input": {
                            "carrier_submissions": "{carrier_submissions}",
                            "answers": "{carrier_questions}"
                        }
                    },
                    "transitions": {
                        "sent": "awaitCarrierResponse"
                    }
                },
                "presentQuote": {
                    "type": "prompt",
                    "prompt": "uw/presentQuote.md",
                    "fields": [],
                    "transitions": {
                        "approve": "ready_for_payment",
                        "revise": "requestRevision"
                    }
                },
                "requestRevision": {
                    "type": "prompt",
                    "prompt": "uw/requestRevision.md",
                    "fields": [
                        "limits_requested",
                        "deductible_preference_ils"
                    ],
                    "transitions": {
                        "submit": "submitRevision"
                    }
                },
                "submitRevision": {
                    "type": "action",
                    "action": {
                        "toolName": "choco.carriers.requestRevision",
                        "input": {
                            "carrier_submissions": "{carrier_submissions}",
                            "limits_requested": "{limits_requested}",
                            "deductible_preference_ils": "{deductible_preference_ils}"
                        }
                    },
                    "transitions": {
                        "ok": "awaitCarrierResponse"
                    }
                },
                "ready_for_payment": {
                    "type": "terminal",
                    "config": {
                        "onComplete": {
                            "startFlowSlug": "approvalAndPayment",
                            "mode": "seamless"
                        }
                    }
                },
                "declined": {
                    "type": "terminal"
                },
                "uw_retry": {
                    "type": "prompt",
                    "prompt": "uw/retry.md",
                    "transitions": {
                        "retry": "awaitCarrierResponse"
                    }
                }
            }
        },
        "approvalAndPayment": {
            "type": "finalization",
            "flowConfig": {
                "initialStage": "confirmQuote",
                "successStage": "payment_package_ready",
                "errorStage": "payment_retry"
            },
            "fieldDefinitions": {
                "customer_approved": {
                    "type": "boolean"
                },
                "payment_method": {
                    "type": "string",
                    "enum": [
                        "credit_card"
                    ]
                },
                "cc_token": {
                    "type": "string"
                },
                "cc_last4": {
                    "type": [
                        "string",
                        "null"
                    ]
                },
                "cc_expiry": {
                    "type": [
                        "string",
                        "null"
                    ]
                },
                "cc_authorization_pdf_ref": {
                    "type": [
                        "string",
                        "null"
                    ]
                },
                "signed_documents": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                }
            },
            "stages": {
                "confirmQuote": {
                    "type": "prompt",
                    "prompt": "payment/confirmQuote.md",
                    "fields": [
                        "customer_approved"
                    ],
                    "validation": {
                        "required": [
                            "customer_approved"
                        ]
                    },
                    "transitions": {
                        "approve": "collectCard",
                        "decline": "payment_declined"
                    }
                },
                "collectCard": {
                    "type": "prompt",
                    "prompt": "payment/collectCard.md",
                    "fields": [
                        "payment_method",
                        "cc_token",
                        "cc_last4",
                        "cc_expiry"
                    ],
                    "validation": {
                        "required": [
                            "payment_method",
                            "cc_token"
                        ]
                    },
                    "transitions": {
                        "next": "generateCcPdf"
                    }
                },
                "generateCcPdf": {
                    "type": "action",
                    "action": {
                        "toolName": "choco.docs.generateCreditCardAuthorizationPdf",
                        "input": {
                            "customer": {
                                "first_name": "{first_name}",
                                "last_name": "{last_name}",
                                "email": "{email}",
                                "phone": "{phone}"
                            },
                            "quote": "{quote}",
                            "cc_last4": "{cc_last4}",
                            "cc_expiry": "{cc_expiry}"
                        },
                        "saveResults": {
                            "cc_authorization_pdf_ref": "{result.pdf_ref}"
                        }
                    },
                    "transitions": {
                        "generated": "collectSignature"
                    }
                },
                "collectSignature": {
                    "type": "action",
                    "action": {
                        "toolName": "choco.sign.requestSignature",
                        "input": {
                            "documents": [
                                "{proposal_pdf}",
                                "{cc_authorization_pdf_ref}"
                            ],
                            "signer": {
                                "name": "{first_name} {last_name}",
                                "email": "{email}",
                                "phone": "{phone}"
                            }
                        },
                        "saveResults": {
                            "signed_documents": "{result.signed_documents}"
                        }
                    },
                    "transitions": {
                        "signed": "payment_package_ready"
                    }
                },
                "payment_package_ready": {
                    "type": "terminal",
                    "config": {
                        "onComplete": {
                            "startFlowSlug": "policyIssuance",
                            "mode": "seamless"
                        }
                    }
                },
                "payment_declined": {
                    "type": "terminal"
                },
                "payment_retry": {
                    "type": "prompt",
                    "prompt": "payment/retry.md",
                    "transitions": {
                        "retry": "confirmQuote"
                    }
                }
            }
        },
        "policyIssuance": {
            "type": "service",
            "flowConfig": {
                "initialStage": "sendApprovedPackage",
                "successStage": "issued",
                "errorStage": "issuance_retry"
            },
            "fieldDefinitions": {
                "policy_number": {
                    "type": [
                        "string",
                        "null"
                    ]
                },
                "policy_documents": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                },
                "policy_start_date": {
                    "type": [
                        "string",
                        "null"
                    ],
                    "format": "date"
                },
                "policy_end_date": {
                    "type": [
                        "string",
                        "null"
                    ],
                    "format": "date"
                },
                "issuance_status": {
                    "type": "string",
                    "enum": [
                        "pending",
                        "issued",
                        "failed"
                    ]
                }
            },
            "stages": {
                "sendApprovedPackage": {
                    "type": "action",
                    "action": {
                        "toolName": "choco.carriers.submitApprovedPackage",
                        "input": {
                            "carrier_submissions": "{carrier_submissions}",
                            "attachments": [
                                "{proposal_pdf}",
                                "{cc_authorization_pdf_ref}"
                            ],
                            "signed_documents": "{signed_documents}"
                        }
                    },
                    "transitions": {
                        "sent": "awaitIssuedPolicy"
                    }
                },
                "awaitIssuedPolicy": {
                    "type": "action",
                    "action": {
                        "toolName": "choco.carriers.pollIssuedPolicy",
                        "input": {
                            "carrier_submissions": "{carrier_submissions}"
                        },
                        "saveResults": {
                            "issuance_status": "{result.issuance_status}",
                            "policy_number": "{result.policy_number}",
                            "policy_documents": "{result.policy_documents}",
                            "policy_start_date": "{result.policy_start_date}",
                            "policy_end_date": "{result.policy_end_date}"
                        }
                    },
                    "transitions": {
                        "issued": "issued"
                    }
                },
                "issued": {
                    "type": "terminal",
                    "config": {
                        "onComplete": {
                            "startFlowSlug": "notifications",
                            "mode": "seamless"
                        }
                    }
                },
                "issuance_retry": {
                    "type": "prompt",
                    "prompt": "issuance/retry.md",
                    "transitions": {
                        "retry": "sendApprovedPackage"
                    }
                }
            }
        },
        "notifications": {
            "type": "service",
            "flowConfig": {
                "initialStage": "sendEmail",
                "successStage": "notified",
                "errorStage": "notify_retry"
            },
            "fieldDefinitions": {
                "email_sent_at": {
                    "type": [
                        "string",
                        "null"
                    ],
                    "format": "date-time"
                },
                "whatsapp_sent_at": {
                    "type": [
                        "string",
                        "null"
                    ],
                    "format": "date-time"
                },
                "notification_status": {
                    "type": "string",
                    "enum": [
                        "pending",
                        "sent",
                        "failed"
                    ]
                }
            },
            "stages": {
                "sendEmail": {
                    "type": "action",
                    "action": {
                        "toolName": "choco.notifications.sendEmail",
                        "input": {
                            "to": "{email}",
                            "template": "policyIssued",
                            "attachments": "{policy_documents}",
                            "context": {
                                "policy_number": "{policy_number}",
                                "customer_name": "{first_name} {last_name}"
                            }
                        }
                    },
                    "transitions": {
                        "sent": "sendWhatsApp"
                    }
                },
                "sendWhatsApp": {
                    "type": "action",
                    "action": {
                        "toolName": "choco.notifications.sendWhatsApp",
                        "input": {
                            "to": "{phone}",
                            "template": "policyIssuedWhatsApp",
                            "context": {
                                "policy_number": "{policy_number}"
                            }
                        }
                    },
                    "transitions": {
                        "sent": "notified"
                    }
                },
                "notified": {
                    "type": "terminal"
                },
                "notify_retry": {
                    "type": "prompt",
                    "prompt": "notifications/retry.md",
                    "transitions": {
                        "retry": "sendEmail"
                    }
                }
            }
        },
        "support": {
            "type": "service",
            "flowConfig": {
                "initialStage": "collectRequest",
                "successStage": "support_complete",
                "errorStage": "support_retry"
            },
            "fieldDefinitions": {
                "support_request": {
                    "type": "string"
                },
                "ticket_id": {
                    "type": [
                        "string",
                        "null"
                    ]
                }
            },
            "stages": {
                "collectRequest": {
                    "type": "prompt",
                    "prompt": "support/collectRequest.md",
                    "fields": [
                        "support_request"
                    ],
                    "validation": {
                        "required": [
                            "support_request"
                        ]
                    },
                    "transitions": {
                        "submit": "createTicket"
                    }
                },
                "createTicket": {
                    "type": "action",
                    "action": {
                        "toolName": "choco.support.createTicket",
                        "input": {
                            "request": "{support_request}",
                            "customer": {
                                "first_name": "{first_name}",
                                "last_name": "{last_name}",
                                "email": "{email}",
                                "phone": "{phone}"
                            }
                        },
                        "saveResults": {
                            "ticket_id": "{result.ticket_id}"
                        }
                    },
                    "transitions": {
                        "created": "support_complete"
                    }
                },
                "support_complete": {
                    "type": "terminal"
                },
                "support_retry": {
                    "type": "prompt",
                    "prompt": "support/retry.md",
                    "transitions": {
                        "retry": "collectRequest"
                    }
                }
            }
        }
    }
}